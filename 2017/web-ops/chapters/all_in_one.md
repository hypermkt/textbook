# 全部載せコンテナ

まずは1台のコンテナに以下をインストールしてください。
なぜなら、最初から複数台のホストに分けて冗長構成を組もうとすると、完成までの道のりが長く、うまく動作しないときの原因の切り分けも困難になります。

- Nginx
- Railsアプリ
- MySQL

Nginxは外からのアクセスを受け、それをRailsアプリに渡します。この時点ではリクエストを受け渡しているだけなのでリバースプロキシと呼ぶのは大袈裟ですが、最終的にリバースプロキシとして動くものなので、ここでもリバースプロキシと呼びます。Railsアプリを動かすサーバは、[puma](https://github.com/puma/puma)を使用してください。データベースはこれまではPostgresでしたが、ペパボではMySQLのノウハウが多くあるので、これ以降はMySQLを使用してください。
Railsアプリは、[Capistrano](http://capistranorb.com/)などのツールでデプロイできるようにしてください。
また、Dockerのベースイメージは[ubuntu:16.04](https://hub.docker.com/_/ubuntu/)を使用してください。

<img src="../assets/step1.png" width="500" alt="全部載せコンテナ">

## 手順

### マニュアルインストール

上記の構成を手動で構築してください。このときに、どのようなコマンドを発行し、どのファイルを変更したかは記録しておくようにしましょう。次のステップ以降でPuppetマニフェストを書くときに役立ちます。ここはチームで作業しづらいかもしれませんが、ペアプロや情報共有を行いながら、上記構成を満たしたDockerイメージをチームで1つ作成してください。

### テストの作成

マニュアルインストールによってできたコンテナに対して、Serverspecでテストを行います。どのような項目を確認すればよいか相談しながら、テストを書いてください。今はコンテナ1台に全ての役割が同居している状態ですが、後に分割することを考えて、ロールを意識しながら書くようにしましょう。

### マニフェストの作成

テストが書けたら、それが通るコンテナをつくるPuppetマニフェストを書きます。Standaloneモードで実際にコンテナにマニフェストを適用して、Greenになることを確認してください。なお、ここでもロールを意識しながらマニフェストを書くようにしてください。
